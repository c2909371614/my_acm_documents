define("acm/nowcoder/1.0.177/javascripts-acm/component/contest/chat",["nc","cpn","../../action/acm","ncpc"],function(t,e,n){var i=t("nc"),s=t("cpn"),d=i.$,o=i.Clazz,a=i.Limit,c=i.Component,r=i.Str,p=i.Time,l=i.Event,u=i.Dom,h=i.Sound,g=i.Base,f=i.Db,v=i.Sys,m=s.Select,w=t("../../action/acm"),x=n.exports=o.create();o.mix(x,c,{_template:['<div class="subject-oprt-wrap pannel-chat #{open}" style="display:none;">','<div class="oprt-hd">','<div class="s-pannel-oprt"><a class="icon-angle-up" style="color:#333;margin-top:10px;background:none;"></a></div>','<span class="s-pannel-title">比赛问题咨询</span>',"</div>",'<div class="oprt-bd">','<div class="pannel-chat-list"><div id="jsList"></div></div>','<div class="pannel-chat-type clearfix">','<div role="group" class="btn-group btn-group-xs" id="jsType"></div>','<a href="javascript:void(0);" class="js-show-auto-msg link-green" style="display:inline-block;float:right;font-size:12px;">常见问题</a>',"</div>",'<textarea class="pannel-chat-txt" id="jsTxtIpt"></textarea>',"</div>","</div>"].join(""),listeners:[{name:"render",type:"custom",handler:function(){var t=this,e=t.getEl(),n=t.rawConfig;t.userId=window.globalInfo.ownerId,t.contestId=n.contestId,t.questionId=n.questionId,t.signUpId=n.signUpId,t.manager=n.manager,t.msgMap={},t.initHolderEl(),t.initComponent(),t.initEvent(),t.showTips(),t.initPing(),t.titleEl=e.find("div.oprt-hd span.s-pannel-title"),t.listEl=e.find("#jsList"),t.txtIpt=e.find("#jsTxtIpt"),n.needFixBottom&&t.fixBottom(),e.on("click",function(){t.showTitle(!1)})}},{name:"click div.oprt-hd",handler:function(){this.open(!this.isOpen())}},{name:"click #jsList a.js-auto-msg",handler:function(t){var e=d(t.currentTarget).attr("data-index");return this.showAutoReply(e)}},{name:"click a.js-show-auto-msg",handler:function(t){var e=d(t.currentTarget);a.mark(e)||(this.showTips(),window.setTimeout(function(){a.clear(e)},2500))}}]},{initialize:function M(t){var e=this;t.renderTo=d(t.renderTo||document.body),e.db=new f("ACM-CHAT"),e.isOpenAdBlock=!1,v.checkAdBlock(function(t){e.isOpenAdBlock=!0})},initHolderEl:function y(){var e=this,t=e.rawConfig,n=e.holderEl=d('<div class="code-question-pannel" style="z-index:998;bottom:0px;"><i class="ico-q-msg"></i><span>比赛问题咨询</span><a class="icon-angle-up"></a></div>');t.renderTo.append(n),n.on("click",function(t){t.preventDefault(),t.stopPropagation(),e.open()})},initComponent:function I(){var t=this.getEl();this.typeSelect=new m({renderTo:t.find("#jsType"),renderBy:"replaceWith",cls:"btn-group-xs",options:[{text:"题目问题",value:"1",checked:!0},{text:"系统问题",value:"2"},{text:"其他",value:"4"}],render:function(){this.getEl().width(150)}})},initEvent:function E(){var s=this,o=s.getEl();o.find("textarea.pannel-chat-txt").on("keydown",function(t){if(13===t.keyCode){t.preventDefault();var e=d(t.currentTarget);s.sendMsg(e.val()),e.val("")}}),d(document).on("click",function(t){var e=t.target,n=(s.typeSelect||{}).attachSel,i=n&&n.getEl?n.getEl().get(0):null;!s.isOpen()||e===o.get(0)||d.contains(o.get(0),e)||i&&d.contains(i,e)||s.open(!1)})},initPing:function T(){var e=this,t=p.frequency(8e3),n=0,i=5;!function s(){t(function(){w.ping({body:{contestId:e.contestId,uid:e.userId,previousMessageId:e.previousMessageId},call:function(t){0<t.data.newMsgCount&&e.checkMsg(),n=0},error:function(t){i<=++n&&(e.showNotice({content:"你的网络可能存在连接异常：请检查是否断网并重新连接。"+(e.isOpenAdBlock?"如果你开启了Adblock、Adblock Plus、AdGuard等屏蔽广告插件，请暂时关闭。":""),type:"9",duration:8e3}),n=0)},always:function(){s()}})})}()},fixBottom:function b(){var n=this;if(n._fixBottom)return;n._fixBottom=!0;var i=n.getEl(),s=0,o=d(window),a=o.height(),c=d("div.js-nowcoder-footer"),r=c.position().top,l=(c.height(),0),t=p.frequency(15);function e(){n._stopFixBottom?l=0:t(function(){if(0===l){a=o.height(),r=c.position().top;var t=o.scrollTop(),e=t+a-s;l=r<e?e-r:0,i.css("bottom",l),n.holderEl.css("bottom",l)}else{a=o.height(),r=c.position().top;var t=o.scrollTop(),e=t+a-s;l=r<e?e-r:0,i.css("bottom",l),n.holderEl.css("bottom",l)}})}e(),n.open(!1),o.on("scroll",e),o.on("resize",function(){a=o.height(),e()}),n.listen("fixSize",function(){e()})},fixPos:function C(){this.fire("fixSize")},showMsg:function _(t,e,n){var i=this.listEl,s=e?"出题人":"我";if(!(t=d.trim(t)))return;var o=e?['<div class="pcl-item clearfix">','<div class="pcl-head">','<a class="list-head" href="javascript:void(0);"><img alt="头像" src="//uploadfiles.nowcoder.com/images/20160711/56_1468219359225_DFC72C14F1C7419B93207CC1C1A560C9"></a>','<span class="pcl-name" style="">#{name}</span>',"</div>",'<div class="tooltip fade right in">','<div class="tooltip-arrow" style="top:18px;"></div>','<div class="tooltip-inner letter-chat clearfix">#{msg}</div>',"</div>","</div>"].join(""):['<div class="pcl-item ask-item clearfix">','<div class="pcl-head">','<a class="list-head" href="javascript:void(0);"><img alt="头像" src="//uploadfiles.nowcoder.com/images/20160712/58_1468318308479_449C3253CA2BBED9314D39977A486D0E"></a>','<span class="pcl-name" style="margin-left:9px;">#{name}</span>',"</div>",'<div class="tooltip fade right in">','<div class="tooltip-arrow" style="top:18px"></div>','<div class="tooltip-inner letter-chat clearfix">#{msg}</div>',"</div>","</div>"].join(""),a=r.execTpl(o,{name:s,msg:t},2<arguments.length?!!n:!e);i.append(a),this.bottomMsg()},showAutoReply:function k(t){if(!/^\d+$/.test(t=t||"")||!this._autoMsg)return;var e=+t-1;if(e<0||e>=this._autoMsg.length)return;var n=this._autoMsg[e];return this.showMsg(n.answer||"",!0),!0},showTitle:function j(t){var e=this.getEl(),n="比赛问题咨询"+(t?"(您有未读信息)":"");this.titleEl.html(n),e[t?"addClass":"removeClass"]("has-new-msg"),this.holderEl[t?"addClass":"removeClass"]("new-msg-notice")},bottomMsg:function A(){var t=this.listEl;u.scrollToElBottom(t.parent())},showTips:function B(){var e=this;if(e.getingAutoMsg)return;if(e._autoMsg)return n();function n(){var n=["欢迎参加比赛，我是本场比赛的出题人，如有以下问题，可以点击查询解决方法："];g.forEach(e._autoMsg,function(t,e){n.push(r.execTpl('<a class="js-auto-msg link-green" href="javascript:void(0);" data-index="#{order}">#{order}:#{content}</a>',{order:e+1,content:t.question},!0))}),n.push("如以上问题未解决你的困难，请选择你遇到的问题类型并进行详细描述，我将尽快为你解答。"),n.push("请注意，与比赛内容相关的技术问题一概不做回答，比赛期间请自行思考作答。祝比赛加油^^ ");var t='<div class="pcl-item">'+(n=g.map(n,function(t){return"<p>"+t+"</p>"})).join("")+"</div>";e.showMsg(t,!0)}e.getingAutoMsg=!0,w.faq({query:{contestId:e.contestId},call:function(t){e._autoMsg=t.data,n()},always:function(){e.getingAutoMsg=!1}})},open:function S(t){var e=this,n=e.getEl();!1===t?n.hide(50,function(){n.removeClass("open"),e.holderEl.show(100)}):(e.holderEl.hide(50,function(){n.addClass("open").show(100,function(){e.txtIpt.focus(),e.bottomMsg()})}),e.showTitle(!1))},isOpen:function q(){return this.getEl().hasClass("open")},sendMsg:function O(n){var i=this;if(!(n=d.trim(n)))return;w.newMessage({type:"POST",body:{contestId:i.contestId,problemId:i.questionId,content:n,type:i.typeSelect.val(),uid:i.userId},call:function(t){var e=t.data+"";i.msgMap[e]={content:n,id:t.data,isSelf:!0},i.showMsg(n)},error:function(t){i.showMsg("消息“ "+n+" ”发送失败",!0,!0)}})},checkMsg:function D(r){var l=this;if(l._requesting)return;l._requesting=!0,r=+r||1,w.messagesList({query:{contestId:l.contestId,uid:l.userId,previousMessageId:l.previousMessageId,page:r},call:function(t){var e=t.data,n=+e.totalPage||1,i=e.messages||[];l.db.refresh();var o=+l.db.get(l.signUpId)||0,a=!1;g.forEach(i,function(t){var e=g.id(t.id),n=d.trim(t.content),i=t.isAcmManager,s=o>=t.id||!i;!l.msgMap[e]&&n&&(l.msgMap[e]=t,l.showMsg(n,i,!1),s||(a=!0,"3"===g.id(t.type)&&l.showNotice(n)))});var s=i[i.length-1]||{},c=s.id;c&&(l.previousMessageId=Math.max(c,l.previousMessageId||0),document.hidden||l.db.set(l.signUpId,Math.max(l.previousMessageId,l.db.get(l.signUpId)||0),864e5)),a&&!l.isOpen()&&l.showTitle(!0),l._requesting=!1,r<n&&l.checkMsg()},error:function(t){l._requesting=!1}})},stopFixBottom:function z(t){this._stopFixBottom=!1!==t},showNotice:function N(t){l.fire("MSG_EVENT_NOTICE_SHOW",t),this.soundNotice()},soundNotice:function P(){try{this._noticeSound=this._noticeSound||new h("//uploadfiles.nowcoder.com/acts/cts/notice.mp3"),this._noticeSound.stop(),this._noticeSound.play()}catch(t){}},_getData:function F(t){return{open:t.open?"open":""}}})});